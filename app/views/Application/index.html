#{extends 'main.html' /}
#{set title:'Apotheek van wacht' /}

<div id="bodyWrapper">
    <div id="body">
        <div id="loadingMessage">De apotheek van wacht het dichtst bij je in de buurt komt er aan.<br/><img class="spinner" src="/public/images/ajax-loader.gif"></div>
    </div>
</div>

<script>
    $(function () {
        moment.lang("nl");

        if(!navigator.geolocation) {
            navigator.geolocation = geolocationShim();
        }

        navigator.geolocation.getCurrentPosition(function (location) {
            zoekApothekenVanWacht(location.coords.latitude, location.coords.longitude);
        });

        function zoekApothekenVanWacht(latitude, longitude) {
            $.get('/zoekApothekenVanWacht/' + latitude + '/' + longitude, function (data) {
                if(data == "bellen") {
                    showBellenMessage();
                    return;
                }
                if(data.length == 0) {
                    showError();
                    return;
                }
                $('#loadingMessage').hide();
                var apotheekVanWacht = data[0];
                var section = $('<div class="apotheekVanWacht">').append($('<h3>').html(apotheekVanWacht.naam));
                var address = apotheekVanWacht.straatEnNummer + " - " + apotheekVanWacht.stad;
                var tel = $('<div class="tel">').html($('<a>').attr('href', 'tel:' + apotheekVanWacht.tel).html(apotheekVanWacht.tel));
                if (apotheekVanWacht.url) {
                    tel.append(' - ').append($('<a>').attr('target', '_blank').html('Website').attr('href', apotheekVanWacht.url));
                }
                section
                        .append($('<div>').html($('<a>').attr('target', '_blank').attr('href', 'http://maps.google.com/maps?daddr=' + address).html(address)))
                        .append($('<div>').html("(" + formatAfstand(apotheekVanWacht.afstand) + " van hier)"))
                        .append(tel)
                        .append($('<div>').html("Wachtdienst eindigt " + moment(apotheekVanWacht.eindDatum, "DD/MM/YYYY hh:mm:ss").calendar()))
                        .appendTo($('#body'));
            }).error(function(err) {
                console.dir(err)
                showError();
            });
        }

        function geolocationShim() {
            var shim = {};
            shim.getCurrentPosition = function (callback) {
                $.ajax({
                    type: 'GET',
                    url: 'http://freegeoip.net/json/',
                    dataType: "jsonp",
                    success: function (data, status) {
                        callback({ coords: { 'latitude': data.latitude, 'longitude': data.longitude }});
                    }
                });
            }
            return shim;
        }

        function showError() {
            $('#loadingMessage').html('Het spijt ons, maar er ging iets mis. Probeer het op <a href="http://www.apotheek.be/apotheker/apotheek-van-wacht">apotheek.be</a>.');
        }

        function showBellenMessage() {
            $('#loadingMessage').html('Tussen 22u en 9u moet je bellen naar het nummer <a href="tel:090392248">0903/92.248</a> voor de apotheek van wacht');
        }

        function formatAfstand(afstand) {
            if(afstand < 1) {
                return "minder dan een kilometer";
            }
            return afstand.toFixed(0) + " kilometer";
        }

        function olderThanIE9() {
            return $.browser.msie && $.browser.version < 9;
        }

        Array.prototype.findOne = function (predicate) {
            for (var i = 0; i < this.length; ++i) {
                if (predicate(this[i])) {
                    return this[i];
                }
            }
        }
    });
</script>

<script type="text/javascript">stLight.options({publisher: "598bea51-7fcc-47df-ab62-dd85181c0059", doNotHash: false, doNotCopy: false, hashAddressBar: false});</script>
<script>
    var options={ "publisher": "598bea51-7fcc-47df-ab62-dd85181c0059", "logo": { "visible": true, "url": "http://www.deapotheekvanwacht.be", "img": "http://sd.sharethis.com/disc/images/demo_logo.png", "height": 45}, "ad": { "visible": false, "openDelay": "5", "closeDelay": "0"}, "livestream": { "domain": "", "type": "sharethis"}, "ticker": { "visible": false, "domain": "", "title": "", "type": "sharethis"}, "facebook": { "visible": false, "profile": "sharethis"}, "fblike": { "visible": false, "url": ""}, "twitter": { "visible": false, "user": "sharethis"}, "twfollow": { "visible": false}, "custom": [{ "visible": false, "title": "Custom 1", "url": "", "img": "", "popup": false, "popupCustom": { "width": 300, "height": 250}}, { "visible": false, "title": "Custom 2", "url": "", "img": "", "popup": false, "popupCustom": { "width": 300, "height": 250}}, { "visible": false, "title": "Custom 3", "url": "", "img": "", "popup": false, "popupCustom": { "width": 300, "height": 250}}], "chicklets": { "items": ["facebook", "twitter", "googleplus"]}};
    var st_bar_widget = new sharethis.widgets.sharebar(options);
</script>